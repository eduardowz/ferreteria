<ion-header>
  <ion-toolbar color="medium" class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" class="back-button" text=""></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center page-title">
      <span class="title-icon">{{ esAdmin ? '📋' : '🛒' }}</span>
      {{ esAdmin ? 'Gestión de Pedidos' : 'Mi Carrito' }}
    </ion-title>
    <ion-buttons slot="end">
      <!-- Botón para cambiar rol (solo para demo/testing) -->
      <ion-button fill="clear" (click)="cambiarRolDemo()" class="demo-button">
        <span class="action-emoji">🔄</span>
      </ion-button>
      <ion-button fill="clear" (click)="cerrarSesion()" class="logout-button">
        <span class="action-emoji">🚪</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding order-content">
  <!-- Información del usuario actual -->
  <ion-card class="user-info-card">
    <ion-card-content>
      <p><span class="emoji-icon">👤</span> Usuario: {{ usuarioActual.nombre }}</p>
      <p><span class="emoji-icon">🎭</span> Rol: {{ esAdmin ? 'Administrador' : 'Usuario' }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Vista de Administrador -->
  <div *ngIf="esAdmin">
    <!-- Filtros para admin -->
    <ion-card class="filter-card">
      <ion-card-header>
        <ion-card-title class="filter-title">
          <span class="emoji-icon">🔍</span>
          Filtros
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Estado</ion-label>
          <ion-select [(ngModel)]="filtroEstado" (ionChange)="filtrarPedidos()">
            <ion-select-option value="">Todos</ion-select-option>
            <ion-select-option value="Pendiente">Pendiente</ion-select-option>
            <ion-select-option value="Enviado">Enviado</ion-select-option>
            <ion-select-option value="Entregado">Entregado</ion-select-option>
            <ion-select-option value="Cancelado">Cancelado</ion-select-option>
          </ion-select>
        </ion-item>
        <ion-item>
          <ion-label>Cliente</ion-label>
          <ion-select [(ngModel)]="filtroCliente" (ionChange)="filtrarPedidos()">
            <ion-select-option value="">Todos</ion-select-option>
            <ion-select-option *ngFor="let cliente of clientesUnicos" [value]="cliente">{{cliente}}</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Lista de pedidos para admin -->
    <ion-card class="order-list-card">
      <ion-card-header class="list-header">
        <ion-card-title class="list-title">
          <span class="emoji-icon">📋</span>
          Pedidos del Sistema
        </ion-card-title>
        <ion-note class="order-count">{{pedidosFiltrados.length}} pedido(s)</ion-note>
      </ion-card-header>
      
      <ion-list lines="none" class="order-list">
        <ion-item *ngFor="let p of pedidosFiltrados; let i = index" class="order-item">
          <ion-avatar slot="start" class="order-avatar">
            <span class="avatar-emoji">📝</span>
          </ion-avatar>
          
          <ion-label class="order-info">
            <h2 class="order-title">{{ p.cliente }} - Pedido #{{ p.id }}</h2>
            <div class="order-details">
              <p class="order-detail">
                <span class="detail-emoji">👤</span>
                Usuario: {{ p.usuarioId }}
              </p>
              <p class="order-detail" *ngIf="p.productos && p.productos.length > 0">
                <span class="detail-emoji">📦</span>
                Productos: {{ p.productos.length }} item(s)
              </p>
              <p class="order-detail" *ngIf="!p.productos || p.productos.length === 0">
                <span class="detail-emoji">📦</span>
                Producto: {{ p.producto }}
              </p>
              <p class="order-detail">
                <span class="detail-emoji">🔢</span>
                Cantidad total: {{ p.cantidad }}
              </p>
              <p class="order-detail">
                <span class="detail-emoji">💰</span>
                Total: ${{ p.total }}
              </p>
              <p class="order-detail" *ngIf="p.metodoPago">
                <span class="detail-emoji">💳</span>
                Pago: {{ p.metodoPago }}
              </p>
              <p class="order-detail">
                <span class="detail-emoji">📅</span>
                {{ p.fecha | date:'medium' }}
              </p>
              <p class="order-detail">
                <span class="detail-emoji">🔄</span>
                Estado: 
                <span class="status-badge" [class.status-pending]="p.estado === 'Pendiente'"
                  [class.status-sent]="p.estado === 'Enviado'"
                  [class.status-delivered]="p.estado === 'Entregado'"
                  [class.status-cancelled]="p.estado === 'Cancelado'">
                  {{ p.estado }}
                </span>
              </p>
            </div>
          </ion-label>
          
          <ion-buttons slot="end" class="action-buttons">
            <ion-button fill="clear" color="medium" (click)="cambiarEstadoPedido(p)" class="edit-button">
              <span class="action-emoji">🔄</span>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="eliminarPedidoAdmin(p.id)" class="delete-button">
              <span class="action-emoji">🗑️</span>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
    </ion-card>
  </div>

  <!-- Vista de Usuario -->
  <div *ngIf="!esAdmin">
    <!-- Botón para agregar al carrito -->
    <ion-button expand="block" color="medium" (click)="mostrarFormulario = !mostrarFormulario" class="toggle-form-button">
      <span slot="start" class="emoji-icon">{{ mostrarFormulario ? '❌' : '➕' }}</span>
      {{ mostrarFormulario ? 'Cancelar' : 'Agregar al Carrito' }}
    </ion-button>

    <!-- Formulario para agregar productos al carrito -->
    <ion-card *ngIf="mostrarFormulario" class="form-card">
      <ion-card-header class="form-header">
        <ion-card-title class="form-title">
          <span class="emoji-icon">🛒</span>
          Agregar Producto
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content class="form-content">
        <ion-item lines="full" class="form-item">
          <ion-label position="stacked" class="select-label">
            <span class="select-emoji">📦</span>
            Producto
          </ion-label>
          <ion-select 
            [(ngModel)]="nuevoItem.producto" 
            placeholder="Selecciona un producto" 
            class="custom-select"
            (ionChange)="actualizarPrecioProducto()"
          >
            <ion-select-option *ngFor="let p of productos" [value]="p.nombre">
              {{ p.nombre }} - ${{ p.precio }} (Stock: {{ p.stock }})
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item lines="full" class="form-item">
          <ion-label position="floating" class="input-label">
            <span class="input-emoji">🔢</span>
            Cantidad
          </ion-label>
          <ion-input 
            type="number" 
            [(ngModel)]="nuevoItem.cantidad" 
            min="1" 
            [max]="obtenerStockMaximo()"
            class="custom-input"
          ></ion-input>
        </ion-item>

        <div class="price-preview" *ngIf="nuevoItem.producto && nuevoItem.cantidad > 0">
          <p><span class="emoji-icon">💰</span> Precio unitario: ${{ nuevoItem.precio }}</p>
          <p><span class="emoji-icon">💵</span> Subtotal: ${{ nuevoItem.precio * nuevoItem.cantidad }}</p>
        </div>

        <ion-button 
          expand="block" 
          color="medium" 
          (click)="agregarAlCarrito()" 
          class="submit-button"
          [disabled]="!nuevoItem.producto || !nuevoItem.cantidad || nuevoItem.cantidad <= 0"
        >
          <span slot="start" class="emoji-icon">🛒</span>
          Agregar al Carrito
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Carrito -->
    <ion-card class="cart-card" *ngIf="carrito.length > 0">
      <ion-card-header class="list-header">
        <ion-card-title class="list-title">
          <span class="emoji-icon">🛒</span>
          Mi Carrito
        </ion-card-title>
        <ion-note class="order-count">{{carrito.length}} producto(s)</ion-note>
      </ion-card-header>