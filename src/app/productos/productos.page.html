<ion-header>
  <ion-toolbar class="header-toolbar">
    <ion-title class="page-title">
      <span class="title-icon">ğŸ›ï¸</span>
      <span *ngIf="!esAdmin">CatÃ¡logo de Productos</span>
      <span *ngIf="esAdmin">GestiÃ³n de Productos</span>
    </ion-title>
    
    <ion-buttons slot="end">
      <!-- BotÃ³n para mostrar/ocultar carrito (solo para usuarios normales) -->
      <ion-button *ngIf="!esAdmin" fill="clear" (click)="mostrarCarrito = !mostrarCarrito" [color]="mostrarCarrito ? 'light' : 'medium'">
        <ion-icon name="cart-outline"></ion-icon>
        <ion-badge *ngIf="carrito.length > 0" color="danger">{{ obtenerCantidadTotal() }}</ion-badge>
      </ion-button>
      
      <!-- Botones para alternar vista (solo visible para admin) -->
      <ion-button *ngIf="esAdmin" fill="clear" (click)="cambiarVista('grid')" [color]="vistaActual === 'grid' ? 'light' : 'medium'">
        <ion-icon name="grid-outline"></ion-icon>
      </ion-button>
      <ion-button *ngIf="esAdmin" fill="clear" (click)="cambiarVista('lista')" [color]="vistaActual === 'lista' ? 'light' : 'medium'">
        <ion-icon name="list-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="product-content">
  <!-- NUEVA SECCIÃ“N: BUSCADOR DE PRODUCTOS -->
  <ion-card class="search-card">
    <ion-card-header>
      <ion-card-title class="search-title">
        <span class="emoji-icon">ğŸ”</span>
        Buscar Productos
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="search-container">
        <ion-item class="search-item">
          <ion-input 
            placeholder="Buscar por nombre, descripciÃ³n, categorÃ­a o proveedor..." 
            [(ngModel)]="terminoBusqueda" 
            (ionInput)="buscarProductos()"
            clearInput="true">
          </ion-input>
          <ion-button slot="end" fill="clear" (click)="limpiarBusqueda()" *ngIf="terminoBusqueda">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </div>
      <div class="search-results" *ngIf="terminoBusqueda">
        <span class="search-count">
          <span class="emoji-icon">ğŸ“Š</span>
          {{ productosFiltrados.length }} producto(s) encontrado(s)
        </span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- SECCIÃ“N DEL CARRITO MEJORADA CON SISTEMA DE DESCUENTOS -->
  <ion-card *ngIf="!esAdmin && mostrarCarrito" class="cart-card">
    <ion-card-header class="cart-header">
      <ion-card-title class="cart-title">
        <span class="emoji-icon">ğŸ›’</span>
        Mi Carrito de Compras
      </ion-card-title>
      <div class="cart-count">
        <span class="emoji-icon">ğŸ“Š</span>
        {{ carrito.length }} producto(s) - {{ obtenerCantidadTotal() }} unidades
      </div>
    </ion-card-header>
    <ion-card-content>
      <div *ngIf="carrito.length === 0" class="empty-cart">
        <span class="emoji-icon">ğŸ›’</span>
        Tu carrito estÃ¡ vacÃ­o
      </div>
      
      <ion-list *ngIf="carrito.length > 0" class="cart-list">
        <ion-item *ngFor="let item of carrito; let i = index" class="cart-item">
          <div class="cart-product-avatar">
            <span class="avatar-emoji">ğŸ¥¤</span>
          </div>
          <div class="cart-product-info">
            <div class="cart-product-name">{{ item.nombre }}</div>
            <div class="cart-product-details">
              <div class="cart-detail">
                <span class="detail-emoji">ğŸ’°</span>
                Precio: ${{ item.precio }}
              </div>
              <div class="cart-detail">
                <span class="detail-emoji">ğŸ“¦</span>
                Cantidad: {{ item.cantidad }}
              </div>
              <div class="cart-detail">
                <span class="detail-emoji">ğŸ’µ</span>
                Subtotal: ${{ item.total.toFixed(2) }}
              </div>
            </div>
          </div>
          <div class="cart-actions" slot="end">
            <ion-button fill="clear" color="success" (click)="aumentarCantidad(item.id)">
              <ion-icon name="add-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="warning" (click)="disminuirCantidad(item.id)">
              <ion-icon name="remove-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="eliminarDelCarrito(item.id)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
      
      <!-- NUEVA SECCIÃ“N: RESUMEN CON DESCUENTOS -->
      <div *ngIf="carrito.length > 0" class="cart-summary">
        <div class="summary-line">
          <span>
            <span class="emoji-icon">ğŸ“</span>
            Subtotal:
          </span>
          <span class="summary-amount">${{ calcularSubtotal().toFixed(2) }}</span>
        </div>
        
        <!-- InformaciÃ³n de descuento -->
        <div class="discount-info" *ngIf="aplicaDescuento()">
          <div class="summary-line discount-line">
            <span>
              <span class="emoji-icon">ğŸ‰</span>
              Descuento ({{ porcentajeDescuento }}%):
            </span>
            <span class="discount-amount">-${{ calcularDescuento().toFixed(2) }}</span>
          </div>
          <div class="discount-message">
            <span class="emoji-icon">âœ¨</span>
            Â¡Felicidades! Tu compra califica para descuento
          </div>
        </div>
        
        <div class="discount-info" *ngIf="!aplicaDescuento()">
          <div class="discount-message-warning">
            <span class="emoji-icon">ğŸ’¡</span>
            Compra ${{ (montoMinimoDescuento - calcularSubtotal()).toFixed(2) }} mÃ¡s y obtÃ©n {{ porcentajeDescuento }}% de descuento
          </div>
        </div>
        
        <div class="summary-line total-line">
          <span class="total-label">
            <span class="emoji-icon">ğŸ’°</span>
            Total a Pagar:
          </span>
          <span class="total-amount">${{ calcularTotalCarrito().toFixed(2) }}</span>
        </div>
        
        <ion-button expand="block" color="success" class="checkout-button" (click)="mostrarOpcionesPago()">
          <span class="action-emoji">ğŸ’³</span>
          Proceder al Pago
        </ion-button>
        <ion-button expand="block" fill="outline" color="danger" class="clear-cart-button" (click)="vaciarCarrito()">
          <span class="action-emoji">ğŸ—‘ï¸</span>
          Vaciar Carrito
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- NUEVA SECCIÃ“N: MODAL DE PAGO -->
  <ion-modal [isOpen]="mostrarPago" (didDismiss)="cerrarPago()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            <span class="emoji-icon">ğŸ’³</span>
            Finalizar Compra
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarPago()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="payment-content">
        <!-- Resumen de compra -->
        <ion-card class="payment-summary">
          <ion-card-header>
            <ion-card-title>
              <span class="emoji-icon">ğŸ“‹</span>
              Resumen de Compra
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="payment-line">
              <span>Subtotal:</span>
              <span>${{ calcularSubtotal().toFixed(2) }}</span>
            </div>
            <div class="payment-line" *ngIf="aplicaDescuento()">
              <span>Descuento ({{ porcentajeDescuento }}%):</span>
              <span class="discount-amount">-${{ calcularDescuento().toFixed(2) }}</span>
            </div>
            <div class="payment-line total-payment">
              <span><strong>Total a Pagar:</strong></span>
              <span><strong>${{ calcularTotalCarrito().toFixed(2) }}</strong></span>
            </div>
            <div *ngIf="aplicaDescuento()" class="savings-message">
              <span class="emoji-icon">ğŸ‰</span>
              Â¡Ahorras ${{ calcularDescuento().toFixed(2) }}!
            </div>
          </ion-card-content>
        </ion-card>

        <!-- MÃ©todos de pago -->
        <ion-card class="payment-methods">
          <ion-card-header>
            <ion-card-title>
              <span class="emoji-icon">ğŸ’³</span>
              Selecciona MÃ©todo de Pago
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item button (click)="seleccionarMetodoPago('efectivo')" [class.selected]="metodoPagoSeleccionado === 'efectivo'">
                <div class="payment-option">
                  <span class="payment-emoji">ğŸ’µ</span>
                  <div>
                    <div class="payment-title">Efectivo</div>
                    <div class="payment-description">Pago en efectivo al recibir</div>
                  </div>
                </div>
                <ion-icon *ngIf="metodoPagoSeleccionado === 'efectivo'" name="checkmark-circle" color="success" slot="end"></ion-icon>
              </ion-item>
              
              <ion-item button (click)="seleccionarMetodoPago('tarjeta')" [class.selected]="metodoPagoSeleccionado === 'tarjeta'">
                <div class="payment-option">
                  <span class="payment-emoji">ğŸ’³</span>
                  <div>
                    <div class="payment-title">Tarjeta</div>
                    <div class="payment-description">Tarjeta de dÃ©bito o crÃ©dito</div>
                  </div>
                </div>
                <ion-icon *ngIf="metodoPagoSeleccionado === 'tarjeta'" name="checkmark-circle" color="success" slot="end"></ion-icon>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- BotÃ³n de confirmaciÃ³n -->
        <div class="payment-actions">
          <ion-button 
            expand="block" 
            color="success" 
            (click)="confirmarCompra()" 
            [disabled]="!metodoPagoSeleccionado"
            class="confirm-button">
            <span class="action-emoji">âœ…</span>
            Confirmar Compra - ${{ calcularTotalCarrito().toFixed(2) }}
          </ion-button>
          <ion-button expand="block" fill="outline" color="medium" (click)="cerrarPago()">
            <span class="action-emoji">â†©ï¸</span>
            Cancelar
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- BotÃ³n para mostrar formulario (solo admin) -->
  <ion-button *ngIf="esAdmin" 
              expand="block" 
              class="toggle-form-button" 
              color="danger" 
              (click)="mostrarFormulario = !mostrarFormulario; resetearFormulario()">
    <span class="emoji-icon">{{ mostrarFormulario ? 'âŒ' : 'â•' }}</span>
    {{ mostrarFormulario ? 'Cancelar' : 'Agregar Producto' }}
  </ion-button>

  <!-- Formulario para agregar/editar producto (solo admin) -->
  <ion-card *ngIf="mostrarFormulario && esAdmin" class="form-card">
    <ion-card-header class="form-header">
      <ion-card-title class="form-title">
        <span class="emoji-icon">{{ nuevoProducto.id === 0 ? 'â•' : 'âœï¸' }}</span>
        {{ nuevoProducto.id === 0 ? 'Agregar Producto' : 'Editar Producto' }}
      </ion-card-title>
    </ion-card-header>
    <ion-card-content class="form-content">
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ·ï¸</span>Nombre
        </ion-label>
        <ion-input class="custom-input" [(ngModel)]="nuevoProducto.nombre" placeholder="Nombre del producto"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ“</span>DescripciÃ³n
        </ion-label>
        <ion-textarea class="custom-input" [(ngModel)]="nuevoProducto.descripcion" placeholder="DescripciÃ³n del producto"></ion-textarea>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ’°</span>Precio ($)
        </ion-label>
        <ion-input class="custom-input" type="number" [(ngModel)]="nuevoProducto.precio" placeholder="0.00"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ“¦</span>Stock
        </ion-label>
        <ion-input class="custom-input" type="number" [(ngModel)]="nuevoProducto.stock" placeholder="0"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸª</span>CategorÃ­a
        </ion-label>
        <ion-input class="custom-input" [(ngModel)]="nuevoProducto.categoria" placeholder="CategorÃ­a"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ“…</span>Fecha
        </ion-label>
        <ion-input class="custom-input" type="date" [(ngModel)]="nuevoProducto.fecha"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ­</span>Proveedor
        </ion-label>
        <ion-input class="custom-input" [(ngModel)]="nuevoProducto.proveedor" placeholder="Nombre del proveedor"></ion-input>
      </ion-item>
      
      <ion-item class="form-item">
        <ion-label class="input-label" position="stacked">
          <span class="input-emoji">ğŸ–¼ï¸</span>URL de Imagen
        </ion-label>
        <ion-input class="custom-input" [(ngModel)]="nuevoProducto.image" placeholder="assets/images/producto.jpg"></ion-input>
      </ion-item>
      
      <ion-button expand="block" 
                  class="submit-button" 
                  color="danger" 
                  (click)="guardarProducto()">
        <span class="action-emoji">{{ nuevoProducto.id === 0 ? 'â•' : 'âœ…' }}</span>
        {{ nuevoProducto.id === 0 ? 'Agregar' : 'Actualizar' }}
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Vista Grid (estilo catÃ¡logo visual) - ACTUALIZADA PARA USAR PRODUCTOS FILTRADOS -->
  <div *ngIf="vistaActual === 'grid'">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let producto of productosFiltrados; let i = index">
          <ion-card class="product-card">
            <ion-img [src]="producto.image || 'assets/images/placeholder.jpg'" [alt]="producto.nombre"></ion-img>
            <ion-card-header>
              <ion-card-title>{{ producto.nombre }}</ion-card-title>
              <ion-card-subtitle *ngIf="producto.stock === 0" class="out-of-stock">
                <span class="emoji-icon">âŒ</span>
                Sin Stock
              </ion-card-subtitle>
              <ion-card-subtitle *ngIf="producto.stock > 0 && producto.stock <= 10" class="low-stock">
                <span class="emoji-icon">âš ï¸</span>
                Ãšltimas {{ producto.stock }} unidades
              </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <p class="product-description">{{ producto.descripcion }}</p>
              <p class="product-price">
                <span class="emoji-icon">ğŸ’°</span>
                <strong>${{ producto.precio }}</strong>
              </p>
              <p *ngIf="esAdmin" class="admin-info">
                <span class="emoji-icon">ğŸ“¦</span>
                Stock: {{ producto.stock }}
              </p>
              <p *ngIf="esAdmin" class="admin-info">
                <span class="emoji-icon">ğŸª</span>
                {{ producto.categoria }}
              </p>
              <p *ngIf="esAdmin" class="admin-info">
                <span class="emoji-icon">ğŸ­</span>
                {{ producto.proveedor }}
              </p>
              
              <!-- Botones para usuarios normales -->
              <ion-button *ngIf="!esAdmin" 
                         expand="block" 
                         (click)="agregarAlCarrito(producto)" 
                         [disabled]="producto.stock === 0"
                         [color]="producto.stock === 0 ? 'medium' : 'primary'">
                <ion-icon [name]="producto.stock === 0 ? 'ban-outline' : 'cart-outline'" slot="start"></ion-icon>
                {{ producto.stock === 0 ? 'Sin Stock' : 'Agregar al Carrito' }}
              </ion-button>
              
              <!-- Botones para administradores -->
              <div *ngIf="esAdmin" class="admin-buttons">
                <ion-button size="small" fill="outline" color="warning" (click)="editarProducto(i)">
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  Editar
                </ion-button>
                <ion-button size="small" fill="outline" color="danger" (click)="eliminarProducto(i)">
                  <ion-icon name="trash-outline" slot="start"></ion-icon>
                  Eliminar
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Vista Lista (estilo administrativo) - ACTUALIZADA PARA USAR PRODUCTOS FILTRADOS -->
  <ion-card *ngIf="vistaActual === 'lista' && esAdmin" class="product-list-card">
    <ion-card-header class="list-header">
      <ion-card-title class="list-title">
        <span class="emoji-icon">ğŸ“‹</span>
        Lista de Productos
      </ion-card-title>
      <div class="product-count">
        <span class="emoji-icon">ğŸ“Š</span>
        {{ productosFiltrados.length }} producto(s)
        <span *ngIf="terminoBusqueda"> de {{ productos.length }} total</span>
      </div>
    </ion-card-header>
    <ion-card-content>
      <ion-list class="product-list">
        <ion-item *ngFor="let producto of productosFiltrados; let i = index" class="product-item">
          <div class="product-avatar">
            <span class="avatar-emoji">ğŸ¥¤</span>
          </div>
          <div class="product-info">
            <div class="product-name">
              {{ producto.nombre }}
              <span class="product-id">#{{ producto.id }}</span>
              <span *ngIf="producto.stock === 0" class="stock-badge out-of-stock-badge">SIN STOCK</span>
              <span *ngIf="producto.stock > 0 && producto.stock <= 10" class="stock-badge low-stock-badge">BAJO STOCK</span>
            </div>
            <div class="product-description">{{ producto.descripcion }}</div>
            <div class="product-details">
              <div class="product-detail">
                <span class="detail-emoji">ğŸ’°</span>
                Precio: ${{ producto.precio }}
              </div>
              <div class="product-detail">
                <span class="detail-emoji">ğŸ“¦</span>
                Stock: {{ producto.stock }}
              </div>
              <div class="product-detail">
                <span class="detail-emoji">ğŸª</span>
                CategorÃ­a: {{ producto.categoria }}
              </div>
              <div class="product-detail">
                <span class="detail-emoji">ğŸ­</span>
                Proveedor: {{ producto.proveedor }}
              </div>
              <div class="product-detail">
                <span class="detail-emoji">ğŸ“…</span>
                Fecha: {{ producto.fecha }}
              </div>
            </div>
          </div>
          <div class="action-buttons" slot="end">
            <ion-button class="edit-button" fill="clear" color="warning" (click)="editarProducto(i)">
              <span class="action-emoji">âœï¸</span>
            </ion-button>
            <ion-button class="delete-button" fill="clear" color="danger" (click)="eliminarProducto(i)">
              <span class="action-emoji">ğŸ—‘ï¸</span>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Mensaje cuando no hay productos o no se encuentran resultados -->
  <ion-card *ngIf="productosFiltrados.length === 0" class="product-list-card">
    <ion-card-content>
      <div class="empty-state">
        <span class="emoji-icon" *ngIf="!terminoBusqueda">ğŸ“­</span>
        <span class="emoji-icon" *ngIf="terminoBusqueda">ğŸ”</span>
        <p *ngIf="!terminoBusqueda">No hay productos disponibles</p>
        <p *ngIf="terminoBusqueda">
          No se encontraron productos con "{{ terminoBusqueda }}"
        </p>
        <ion-button *ngIf="terminoBusqueda" fill="outline" (click)="limpiarBusqueda()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Ver todos los productos
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- InformaciÃ³n adicional para usuarios -->
  <ion-card *ngIf="!esAdmin" class="info-card">
    <ion-card-content>
      <div class="discount-info-section">
        <div class="discount-title">
          <span class="emoji-icon">ğŸ</span>
          Â¡Aprovecha nuestros descuentos!
        </div>
        <div class="discount-details">
          <span class="emoji-icon">ğŸ’¡</span>
          Compra ${{ montoMinimoDescuento }} o mÃ¡s y obtÃ©n {{ porcentajeDescuento }}% de descuento automÃ¡ticamente
        </div>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>