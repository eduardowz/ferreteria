<ion-header>
  <ion-toolbar class="header-toolbar">
    <ion-title class="page-title">
      <span class="title-icon">üõçÔ∏è</span>
      <span *ngIf="!esAdmin">Cat√°logo de Productos</span>
      <span *ngIf="esAdmin">Gesti√≥n de Productos</span>
    </ion-title>
    
    <ion-buttons slot="end">
      <!-- Bot√≥n para mostrar/ocultar carrito (solo para usuarios normales) -->
      <ion-button *ngIf="!esAdmin" fill="clear" (click)="mostrarCarrito = !mostrarCarrito" [color]="mostrarCarrito ? 'light' : 'medium'">
        <ion-icon name="cart-outline"></ion-icon>
        <ion-badge *ngIf="carrito.length > 0" color="danger">{{ obtenerCantidadTotal() }}</ion-badge>
      </ion-button>
      
      <!-- Botones para alternar vista (solo visible para admin) -->
      <ion-button *ngIf="esAdmin" fill="clear" (click)="cambiarVista('grid')" [color]="vistaActual === 'grid' ? 'light' : 'medium'">
        <ion-icon name="grid-outline"></ion-icon>
      </ion-button>
      <ion-button *ngIf="esAdmin" fill="clear" (click)="cambiarVista('lista')" [color]="vistaActual === 'lista' ? 'light' : 'medium'">
        <ion-icon name="list-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="product-content">
  <!-- SECCI√ìN DE B√öSQUEDA MEJORADA -->
  <div class="search-section">
    <ion-card class="search-card">
      <ion-card-content>
        <div class="search-container">
          <ion-searchbar
            [(ngModel)]="terminoBusqueda"
            (ionInput)="buscarProductos()"
            placeholder="Buscar productos..."
            show-clear-button="focus"
            class="custom-searchbar">
          </ion-searchbar>
          <div class="search-results" *ngIf="terminoBusqueda">
            <span class="search-count">
              <ion-icon name="analytics-outline"></ion-icon>
              {{ productosFiltrados.length }} producto(s) encontrado(s)
            </span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- CARRITO MEJORADO CON MEJOR DISE√ëO -->
  <div class="cart-section" *ngIf="!esAdmin && mostrarCarrito">
    <ion-card class="cart-card-modern">
      <ion-card-header class="cart-header-modern">
        <div class="cart-title-section">
          <h2>üõí Mi Carrito</h2>
          <span class="cart-items-count">{{ carrito.length }} productos</span>
        </div>
        <ion-button fill="clear" color="medium" (click)="mostrarCarrito = false">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </ion-card-header>
      
      <ion-card-content>
        <div *ngIf="carrito.length === 0" class="empty-cart-modern">
          <ion-icon name="cart-outline" class="empty-cart-icon"></ion-icon>
          <p>Tu carrito est√° vac√≠o</p>
        </div>
        
        <div *ngIf="carrito.length > 0">
          <div class="cart-items-modern">
            <div *ngFor="let item of carrito" class="cart-item-modern">
              <div class="item-image">ü•§</div>
              <div class="item-details">
                <h4>{{ item.nombre }}</h4>
                <p class="item-price">${{ item.precio }}</p>
                <div class="quantity-controls">
                  <ion-button fill="clear" size="small" (click)="disminuirCantidad(item.id)">
                    <ion-icon name="remove-outline"></ion-icon>
                  </ion-button>
                  <span class="quantity">{{ item.cantidad }}</span>
                  <ion-button fill="clear" size="small" (click)="aumentarCantidad(item.id)">
                    <ion-icon name="add-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
              <div class="item-total">
                <span>${{ item.total.toFixed(2) }}</span>
                <ion-button fill="clear" color="danger" size="small" (click)="eliminarDelCarrito(item.id)">
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
          
          <!-- RESUMEN MEJORADO -->
          <div class="cart-summary-modern">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span>${{ calcularSubtotal().toFixed(2) }}</span>
            </div>
            
            <div class="summary-row discount-row" *ngIf="aplicaDescuento()">
              <span>üéâ Descuento ({{ porcentajeDescuento }}%):</span>
              <span class="discount-amount">-${{ calcularDescuento().toFixed(2) }}</span>
            </div>
            
            <div class="discount-message" *ngIf="!aplicaDescuento()">
              üí° Compra ${{ (montoMinimoDescuento - calcularSubtotal()).toFixed(2) }} m√°s y obt√©n {{ porcentajeDescuento }}% de descuento
            </div>
            
            <div class="summary-row total-row">
              <span><strong>Total:</strong></span>
              <span><strong>${{ calcularTotalCarrito().toFixed(2) }}</strong></span>
            </div>
            
            <div class="cart-actions-modern">
              <ion-button expand="block" color="success" (click)="mostrarOpcionesPago()">
                <ion-icon name="card-outline" slot="start"></ion-icon>
                Proceder al Pago
              </ion-button>
              <ion-button expand="block" fill="outline" color="danger" (click)="vaciarCarrito()">
                <ion-icon name="trash-outline" slot="start"></ion-icon>
                Vaciar Carrito
              </ion-button>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- MODAL DE PAGO MEJORADO CON FORMULARIOS COMPLETOS -->
  <ion-modal [isOpen]="mostrarPago" (didDismiss)="cerrarPago()" class="payment-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>üí≥ Finalizar Compra</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarPago()" fill="clear">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="payment-content">
        <!-- Resumen de compra -->
        <ion-card class="payment-summary-card">
          <ion-card-header>
            <ion-card-title>üìã Resumen de Compra</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="payment-summary-details">
              <div class="summary-line">
                <span>Subtotal:</span>
                <span>${{ calcularSubtotal().toFixed(2) }}</span>
              </div>
              <div class="summary-line" *ngIf="aplicaDescuento()">
                <span>Descuento:</span>
                <span class="discount">-${{ calcularDescuento().toFixed(2) }}</span>
              </div>
              <div class="summary-line total-line">
                <span><strong>Total a Pagar:</strong></span>
                <span><strong>${{ calcularTotalCarrito().toFixed(2) }}</strong></span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- M√©todos de pago -->
        <ion-card class="payment-methods-card">
          <ion-card-header>
            <ion-card-title>üí≥ M√©todo de Pago</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-segment [(ngModel)]="metodoPagoSeleccionado" class="payment-segment">
              <ion-segment-button value="efectivo">
                <ion-label>üíµ Efectivo</ion-label>
              </ion-segment-button>
              <ion-segment-button value="tarjeta">
                <ion-label>üí≥ Tarjeta</ion-label>
              </ion-segment-button>
            </ion-segment>

            <!-- FORMULARIO PARA PAGO EN EFECTIVO -->
            <div *ngIf="metodoPagoSeleccionado === 'efectivo'" class="payment-form">
              <ion-card class="cash-form">
                <ion-card-header>
                  <ion-card-subtitle>Pago en Efectivo</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-item>
                    <ion-label position="stacked">üíµ Dinero Recibido</ion-label>
                    <ion-input 
                      type="number" 
                      [(ngModel)]="dineroRecibido" 
                      placeholder="0.00"
                      min="0"
                      step="0.01">
                    </ion-input>
                  </ion-item>
                  
                  <div class="change-calculation" *ngIf="dineroRecibido && dineroRecibido >= calcularTotalCarrito()">
                    <div class="change-info">
                      <h4>üí∞ Informaci√≥n del Cambio</h4>
                      <div class="change-details">
                        <div class="change-row">
                          <span>Total a Pagar:</span>
                          <span>${{ calcularTotalCarrito().toFixed(2) }}</span>
                        </div>
                        <div class="change-row">
                          <span>Dinero Recibido:</span>
                          <span>${{ dineroRecibido.toFixed(2) }}</span>
                        </div>
                        <div class="change-row cambio-row">
                          <span><strong>Cambio a Devolver:</strong></span>
                          <span><strong>${{ (dineroRecibido - calcularTotalCarrito()).toFixed(2) }}</strong></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <ion-note *ngIf="dineroRecibido && dineroRecibido < calcularTotalCarrito()" color="danger">
                    ‚ö†Ô∏è El dinero recibido es insuficiente. Faltan ${{ (calcularTotalCarrito() - dineroRecibido).toFixed(2) }}
                  </ion-note>
                </ion-card-content>
              </ion-card>
            </div>

            <!-- FORMULARIO PARA PAGO CON TARJETA -->
            <div *ngIf="metodoPagoSeleccionado === 'tarjeta'" class="payment-form">
              <ion-card class="card-form">
                <ion-card-header>
                  <ion-card-subtitle>Informaci√≥n de la Tarjeta</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-item>
                    <ion-label position="stacked">üí≥ N√∫mero de Tarjeta</ion-label>
                    <ion-input 
                      [(ngModel)]="datosTarjeta.numero" 
                      placeholder="1234 5678 9012 3456"
                      maxlength="19"
                      (ionInput)="formatearNumeroTarjeta($event)">
                    </ion-input>
                  </ion-item>
                  
                  <ion-item>
                    <ion-label position="stacked">üë§ Nombre del Titular</ion-label>
                    <ion-input 
                      [(ngModel)]="datosTarjeta.titular" 
                      placeholder="Juan P√©rez"
                      style="text-transform: uppercase;">
                    </ion-input>
                  </ion-item>
                  
                  <ion-row>
                    <ion-col size="6">
                      <ion-item>
                        <ion-label position="stacked">üìÖ Vencimiento</ion-label>
                        <ion-input 
                          [(ngModel)]="datosTarjeta.vencimiento" 
                          placeholder="MM/AA"
                          maxlength="5"
                          (ionInput)="formatearVencimiento($event)">
                        </ion-input>
                      </ion-item>
                    </ion-col>
                    <ion-col size="6">
                      <ion-item>
                        <ion-label position="stacked">üîí CVV</ion-label>
                        <ion-input 
                          [(ngModel)]="datosTarjeta.cvv" 
                          placeholder="123"
                          maxlength="4"
                          type="password">
                        </ion-input>
                      </ion-item>
                    </ion-col>
                  </ion-row>
                  
                  <ion-item>
                    <ion-label position="stacked">üìß Email (Opcional)</ion-label>
                    <ion-input 
                      [(ngModel)]="datosTarjeta.email" 
                      type="email"
                      placeholder="correo@ejemplo.com">
                    </ion-input>
                  </ion-item>

                  <!-- Tipo de Tarjeta Visual -->
                  <div class="card-type-display" *ngIf="datosTarjeta.numero">
                    <h4>Tipo de Tarjeta Detectada:</h4>
                    <div class="card-brand">
                      <span [ngSwitch]="detectarTipoTarjeta()">
                        <span *ngSwitchCase="'Visa'">üí≥ Visa</span>
                        <span *ngSwitchCase="'Mastercard'">üí≥ Mastercard</span>
                        <span *ngSwitchCase="'American Express'">üí≥ American Express</span>
                        <span *ngSwitchDefault>üí≥ Tarjeta</span>
                      </span>
                    </div>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Botones de confirmaci√≥n -->
        <div class="payment-actions">
          <ion-button 
            expand="block" 
            color="success" 
            (click)="confirmarCompra()" 
            [disabled]="!puedeConfirmarCompra()"
            class="confirm-payment-btn">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            Confirmar Compra - ${{ calcularTotalCarrito().toFixed(2) }}
          </ion-button>
          <ion-button expand="block" fill="outline" color="medium" (click)="cerrarPago()">
            <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Bot√≥n para mostrar formulario (solo admin) -->
  <ion-button *ngIf="esAdmin" 
              expand="block" 
              class="toggle-form-button" 
              color="primary" 
              (click)="mostrarFormulario = !mostrarFormulario; resetearFormulario()">
    <ion-icon [name]="mostrarFormulario ? 'close-outline' : 'add-outline'" slot="start"></ion-icon>
    {{ mostrarFormulario ? 'Cancelar' : 'Agregar Producto' }}
  </ion-button>

  <!-- Formulario para agregar/editar producto (solo admin) -->
  <ion-card *ngIf="mostrarFormulario && esAdmin" class="form-card-modern">
    <ion-card-header>
      <ion-card-title>
        <ion-icon [name]="nuevoProducto.id === 0 ? 'add-circle-outline' : 'create-outline'"></ion-icon>
        {{ nuevoProducto.id === 0 ? 'Agregar Producto' : 'Editar Producto' }}
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="form-grid">
        <ion-item>
          <ion-label position="stacked">üè∑Ô∏è Nombre</ion-label>
          <ion-input [(ngModel)]="nuevoProducto.nombre" placeholder="Nombre del producto"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üìù Descripci√≥n</ion-label>
          <ion-textarea [(ngModel)]="nuevoProducto.descripcion" placeholder="Descripci√≥n del producto"></ion-textarea>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üí∞ Precio ($)</ion-label>
          <ion-input type="number" [(ngModel)]="nuevoProducto.precio" placeholder="0.00"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üì¶ Stock</ion-label>
          <ion-input type="number" [(ngModel)]="nuevoProducto.stock" placeholder="0"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üè™ Categor√≠a</ion-label>
          <ion-input [(ngModel)]="nuevoProducto.categoria" placeholder="Categor√≠a"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üìÖ Fecha</ion-label>
          <ion-input type="date" [(ngModel)]="nuevoProducto.fecha"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üè≠ Proveedor</ion-label>
          <ion-input [(ngModel)]="nuevoProducto.proveedor" placeholder="Nombre del proveedor"></ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">üñºÔ∏è URL de Imagen</ion-label>
          <ion-input [(ngModel)]="nuevoProducto.image" placeholder="assets/images/producto.jpg"></ion-input>
        </ion-item>
      </div>
      
      <ion-button expand="block" color="success" (click)="guardarProducto()" class="save-btn">
        <ion-icon [name]="nuevoProducto.id === 0 ? 'add-outline' : 'checkmark-outline'" slot="start"></ion-icon>
        {{ nuevoProducto.id === 0 ? 'Agregar' : 'Actualizar' }}
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- PRODUCTOS CON SELECTOR DE CANTIDAD MEJORADO -->
  <div class="products-section">
    <!-- Vista Grid mejorada -->
    <div *ngIf="vistaActual === 'grid'">
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="4" *ngFor="let producto of productosFiltrados; let i = index; trackBy: trackByProducto">
            <ion-card class="product-card-modern">
              <div class="product-image-container">
                <ion-img [src]="producto.image || 'assets/images/placeholder.jpg'" [alt]="producto.nombre"></ion-img>
                <div class="stock-indicator" [ngClass]="{
                  'in-stock': producto.stock > 10,
                  'low-stock': producto.stock > 0 && producto.stock <= 10,
                  'out-of-stock': producto.stock === 0
                }">
                  <span *ngIf="producto.stock > 10">‚úÖ En Stock</span>
                  <span *ngIf="producto.stock > 0 && producto.stock <= 10">‚ö†Ô∏è √öltimas {{ producto.stock }}</span>
                  <span *ngIf="producto.stock === 0">‚ùå Sin Stock</span>
                </div>
              </div>
              
              <ion-card-header>
                <ion-card-title class="product-title-modern">{{ producto.nombre }}</ion-card-title>
                <ion-card-subtitle class="product-price-modern">${{ producto.precio }}</ion-card-subtitle>
              </ion-card-header>
              
              <ion-card-content>
                <p class="product-description-modern">{{ producto.descripcion }}</p>
                
                <div *ngIf="esAdmin" class="admin-info-modern">
                  <div class="info-chip">üì¶ Stock: {{ producto.stock }}</div>
                  <div class="info-chip">üè™ {{ producto.categoria }}</div>
                  <div class="info-chip">üè≠ {{ producto.proveedor }}</div>
                </div>
                
                <!-- SELECTOR DE CANTIDAD MEJORADO PARA USUARIOS - CORREGIDO -->
                <div *ngIf="!esAdmin && producto.stock > 0" class="quantity-section-modern">
                  <label class="quantity-label">Cantidad:</label>
                  <div class="quantity-selector-modern">
                    <ion-button fill="outline" size="small" (click)="disminuirCantidadTemporal(i)" [disabled]="(producto.cantidadTemporal ?? 1) <= 1">
                      <ion-icon name="remove-outline"></ion-icon>
                    </ion-button>
                    <span class="quantity-display">{{ producto.cantidadTemporal ?? 1 }}</span>
                    <ion-button fill="outline" size="small" (click)="aumentarCantidadTemporal(i)" [disabled]="(producto.cantidadTemporal ?? 1) >= producto.stock">
                      <ion-icon name="add-outline"></ion-icon>
                    </ion-button>
                  </div>
                  <div class="subtotal-preview">
                    Subtotal: ${{ ((producto.cantidadTemporal ?? 1) * producto.precio).toFixed(2) }}
                  </div>
                </div>
                
                <!-- Botones para usuarios normales -->
                <ion-button *ngIf="!esAdmin" 
                           expand="block" 
                           (click)="agregarAlCarritoConCantidad(producto, i)" 
                           [disabled]="producto.stock === 0"
                           [color]="producto.stock === 0 ? 'medium' : 'success'"
                           class="add-to-cart-btn-modern">
                  <ion-icon [name]="producto.stock === 0 ? 'ban-outline' : 'cart-outline'" slot="start"></ion-icon>
                  {{ producto.stock === 0 ? 'Sin Stock' : 'Agregar al Carrito' }}
                </ion-button>
                
                <!-- Botones para administradores -->
                <div *ngIf="esAdmin" class="admin-buttons-modern">
                  <ion-button fill="outline" color="warning" (click)="editarProducto(i)">
                    <ion-icon name="create-outline" slot="start"></ion-icon>
                    Editar
                  </ion-button>
                  <ion-button fill="outline" color="danger" (click)="eliminarProducto(i)">
                    <ion-icon name="trash-outline" slot="start"></ion-icon>
                    Eliminar
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Vista Lista mejorada para admin -->
    <ion-card *ngIf="vistaActual === 'lista' && esAdmin" class="product-list-modern">
      <ion-card-header>
        <ion-card-title>üìã Lista de Productos ({{ productosFiltrados.length }})</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="list-item-modern" *ngFor="let producto of productosFiltrados; let i = index; trackBy: trackByProducto">
          <div class="product-avatar-modern">ü•§</div>
          <div class="product-details-modern">
            <h3>{{ producto.nombre }} <span class="product-id">#{{ producto.id }}</span></h3>
            <p>{{ producto.descripcion }}</p>
            <div class="product-meta">
              <span>üí∞ ${{ producto.precio }}</span>
              <span>üì¶ Stock: {{ producto.stock }}</span>
              <span>üè™ {{ producto.categoria }}</span>
              <span>üè≠ {{ producto.proveedor }}</span>
            </div>
          </div>
          <div class="action-buttons-modern">
            <ion-button fill="clear" color="warning" (click)="editarProducto(i)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="eliminarProducto(i)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Mensaje cuando no hay productos -->
  <ion-card *ngIf="productosFiltrados.length === 0" class="empty-products">
    <ion-card-content>
      <div class="empty-state-modern">
        <ion-icon name="storefront-outline" class="empty-icon"></ion-icon>
        <h3 *ngIf="!terminoBusqueda">No hay productos disponibles</h3>
        <h3 *ngIf="terminoBusqueda">No se encontraron productos</h3>
        <p *ngIf="terminoBusqueda">Intenta con otros t√©rminos de b√∫squeda</p>
        <ion-button *ngIf="terminoBusqueda" fill="outline" (click)="limpiarBusqueda()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Ver todos los productos
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Informaci√≥n de descuentos para usuarios -->
  <ion-card *ngIf="!esAdmin" class="discount-info-card">
    <ion-card-content>
      <div class="discount-banner">
        <div class="discount-icon">üéÅ</div>
        <div class="discount-text">
          <h4>¬°Aprovecha nuestros descuentos!</h4>
          <p>Compra ${{ montoMinimoDescuento }} o m√°s y obt√©n {{ porcentajeDescuento }}% de descuento autom√°ticamente</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>